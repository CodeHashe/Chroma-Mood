{% extends "layout.html" %}

{% block content %}
<div class="text-center mb-5">
    <h1 class="display-4">Chroma-Mood</h1>
    <p class="lead">Detect emotions from Text, Video, or Voice.</p>
</div>

<ul class="nav nav-tabs justify-content-center mb-4" id="emotionTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button"
            role="tab">Text</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video" type="button"
            role="tab">Video</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="voice-tab" data-bs-toggle="tab" data-bs-target="#voice" type="button"
            role="tab">Voice</button>
    </li>
</ul>

<div class="tab-content" id="emotionTabsContent">
    <!-- Text Section -->
    <div class="tab-pane fade show active" id="text" role="tabpanel">
        <form method="POST" action="/" class="mx-auto" style="max-width: 600px;">
            <div class="mb-3">
                <textarea name="user_text" class="form-control" rows="4"
                    placeholder="How are you feeling today?">{{ user_text }}</textarea>
            </div>
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">Analyze Text</button>
            </div>
        </form>
        {% if emotion and color %}
        <div class="results-container mt-4 text-center">
            <div class="p-4 rounded" style="background-color: {{ color }}; display: inline-block;">
                <h2 class="text-white">{{ emotion }}</h2>
                <p class="text-white lead">{{ color }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Video Section -->
    <div class="tab-pane fade text-center" id="video" role="tabpanel">
        <p>Look at the camera for 10 seconds.</p>
        <div id="video-container" class="mb-3">
            <!-- Video feed will appear here -->
            <img id="video-feed" src="" style="max-width: 100%; display: none; border-radius: 8px;">
        </div>
        <button id="start-video-btn" class="btn btn-success btn-lg">Start Video Analysis</button>
        <div id="video-result" class="mt-4"></div>
    </div>

    <!-- Voice Section -->
    <div class="tab-pane fade text-center" id="voice" role="tabpanel">
        <p>Click to record 5 seconds of audio.</p>
        <button id="record-btn" class="btn btn-danger btn-lg">Record & Analyze</button>
        <div id="voice-status" class="mt-3 text-muted"></div>
        <div id="voice-result" class="mt-4"></div>
    </div>
</div>

<script>
    // Video Logic
    const videoBtn = document.getElementById('start-video-btn');
    const videoFeed = document.getElementById('video-feed');
    const videoResult = document.getElementById('video-result');

    videoBtn.addEventListener('click', () => {
        videoFeed.src = "/video_feed?" + new Date().getTime(); // Prevent caching
        videoFeed.style.display = 'inline-block';
        videoResult.innerHTML = 'Analyzing...';
        videoBtn.disabled = true;

        // Poll for results after 10 seconds
        setTimeout(() => {
            fetch('/video_result')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        videoResult.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                    } else {
                        videoResult.innerHTML = `
                            <div class="p-4 rounded" style="background-color: ${data.color}; display: inline-block;">
                                <h3 class="text-white">Detected: ${data.dominant_emotion} (Score: ${data.score.toFixed(2)})</h3>
                                <p class="text-white lead">Color: ${data.color}</p>
                            </div>
                        `;
                    }
                    videoBtn.disabled = false;
                })
                .catch(err => {
                    videoResult.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
                    videoBtn.disabled = false;
                });
        }, 11000); // Wait slightly more than 10s
    });

    // Voice Logic
    const recordBtn = document.getElementById('record-btn');
    const voiceStatus = document.getElementById('voice-status');
    const voiceResult = document.getElementById('voice-result');

    recordBtn.addEventListener('click', () => {
        voiceStatus.innerText = "Recording for 5 seconds...";
        recordBtn.disabled = true;
        voiceResult.innerHTML = '';

        fetch('/voice_predict', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                voiceStatus.innerText = "";
                recordBtn.disabled = false;
                if (data.error) {
                    voiceResult.innerHTML = `<div class="alert alert-warning">${data.error}</div>`;
                } else {
                    voiceResult.innerHTML = `
                        <div class="p-4 rounded" style="background-color: ${data.color}; display: inline-block;">
                            <h3 class="text-white">Detected: ${data.emotion.toUpperCase()} (Confidence: ${data.confidence.toFixed(2)})</h3>
                            <p class="text-white lead">Color: ${data.color}</p>
                        </div>
                    `;
                }
            })
            .catch(err => {
                voiceStatus.innerText = "";
                recordBtn.disabled = false;
                voiceResult.innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
            });
    });
</script>
{% endblock %}